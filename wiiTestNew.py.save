import cwiid
import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt
from boat import *
import time

while not wiimote: 
    wiimote = cwiid.Wiimote()
print ("Connection established!")
wiimote.rpt_mode = cwiid.RPT_ACC
#wiimote.rpt_mode = cwiid.RPT_IR

try:

      sucksS = Boat()
      time.sleep(1)
      vx = 0
      vy = 0
      ax = 0
      ay = 0
      dt = 0.0001
      t = 0
      accelList = []
      velocityList = []
      sucksS.forward(100)
      time.sleep(0.001)
      while (True):

         
         ax_n= ( wiimote.state['acc'][cwiid.X] - 116)/2
         ay_n= (wiimote.state['acc'][cwiid.Y] - 120)/2
         if (t < 1 and ax_n == 0):
             sucksS.left(100, 1)
             time.sleep(1)
             sucksS.forward(100)
             t = 0
             
         elif (t > 1 and ax_n != 0):
             sucksS.left(100, 1)
             time.sleep(1)
             sucksS.forward(100)
             t = 0
         vx += ax_n*dt
         vy += ay_n*dt
         time.sleep(dt)
         t += dt
         plt.scatter(ax_n, ay_n, marker ='.')
         plt.scatter(vx, vy, marker ='o')
         accelList.append((ax_n,ay_n))
         velocityList.append((vx,vy))
  #f = lambda x : (ax_n/dt)*x
  #vx_n, err = scipy.integrate.quad(f, t, t + dt)
  #f = lambda y : (ay_n/dt)*y
  #vy_n, err = scipy.integrate.quad(f, t, t + dt)
          
          #print ("Acc:", ax_n, ay_n, "Vel:", vx, vy, "Pos:", x, y)

          
      
except KeyboardInterrupt:
    plt.ion()
    
    plt.savefig('tmp.png')
    wiimote.close()
    print("Wiimote closed")
    with open('accellog.txt','w') as accellog:
        for item in accelList:
            accellog.write("X:%d  Y:%d \n" % (item[0],item[1]))
    with open('vellog.txt','w') as vellog:
        for item in velocityList:
            vellog.write("X:%d  Y:%d \n" % (item[0],item[1]))
        
        
        
